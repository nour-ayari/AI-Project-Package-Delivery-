<div class="container" [class.dark-theme]="isDarkTheme">
  <div class="header">
    <h1 class="title">AI Package Delivery Planner</h1>
    <button
      class="theme-toggle"
      (click)="toggleTheme()"
      [title]="isDarkTheme ? 'Switch to light mode' : 'Switch to dark mode'"
    >
      <i class="theme-icon">{{ isDarkTheme ? "üí°" : "üåô" }}</i>
    </button>
  </div>

  <div class="error-container" *ngIf="error" [@shakeAnimation]>
    <div class="error-message">{{ error }}</div>
    <button class="close-btn" (click)="error = null">√ó</button>
  </div>

  <div class="grid-interface">
    <div class="tools-panel">
      <div class="tools-group">
        <h3>Grid Size</h3>
        <div class="grid-size-controls">
          <div class="size-input-group">
            <label for="gridRows">Rows:</label>
            <input
              type="number"
              id="gridRows"
              [(ngModel)]="gridRows"
              (input)="onGridSizeChange()"
              min="3"
              max="20"
              class="size-input"
              title="Number of rows (3-20)"
            />
          </div>
          <div class="size-input-group">
            <label for="gridCols">Columns:</label>
            <input
              type="number"
              id="gridCols"
              [(ngModel)]="gridCols"
              (input)="onGridSizeChange()"
              min="3"
              max="20"
              class="size-input"
              title="Number of columns (3-20)"
            />
          </div>
        </div>
      </div>

      <div class="tools-group">
        <h3>Grid Tools</h3>
        <button
          [class.active]="mode === 'move'"
          (click)="setMode('move')"
          title="Move the canvas"
        >
          <i class="tool-icon">‚Üï</i> Move
        </button>
        <button
          [class.active]="mode === 'add-store'"
          (click)="setMode('add-store')"
          [disabled]="stores.length >= 3"
          [title]="
            stores.length >= 3
              ? 'Maximum 3 stores reached'
              : 'Add a store (pickup location)'
          "
        >
          <i class="tool-icon">üè™</i> Add Store ({{ stores.length }}/3)
        </button>
        <button
          [class.active]="mode === 'add-destination'"
          (click)="setMode('add-destination')"
          [disabled]="destinations.length >= 10"
          [title]="
            destinations.length >= 10
              ? 'Maximum 10 destinations reached'
              : 'Add a destination (delivery location)'
          "
        >
          <i class="tool-icon">üìç</i> Add Destination ({{
            destinations.length
          }}/10)
        </button>
        <button
          [class.active]="mode === 'add-tunnel'"
          (click)="setMode('add-tunnel')"
          title="Add a tunnel (shortcut between two cells)"
        >
          <i class="tool-icon">üöá</i> Add Tunnel
        </button>
        <button
          [class.active]="mode === 'add-roadblock'"
          (click)="setMode('add-roadblock')"
          title="Block a cell"
        >
          <i class="tool-icon">üö´</i> Add Roadblock
        </button>
        <button
          [class.active]="mode === 'add-cost'"
          (click)="setMode('add-cost')"
          title="Set traffic costs on edges (click between cells)"
        >
          <i class="tool-icon">üí∞</i> Add Cost
        </button>

        <!-- Cost Editing Panel -->
        <div
          class="cost-editing-panel"
          *ngIf="isEditingCellCost || isEditingEdgeCost"
          [@slideInAnimation]
        >
          <div class="cost-editor">
            <h4 *ngIf="isEditingCellCost">
              Edit Cell Costs - Cell ({{ editingCellPosition?.x }},
              {{ editingCellPosition?.y }})
            </h4>
            <h4 *ngIf="isEditingEdgeCost">
              Edit Edge Cost - {{ editingEdgeDirection | titlecase }} from ({{
                editingEdgeFrom?.x
              }}, {{ editingEdgeFrom?.y }})
            </h4>

            <div class="cost-inputs" *ngIf="isEditingCellCost">
              <div class="cost-input-group">
                <label>Up:</label>
                <input
                  type="number"
                  [(ngModel)]="editingCellCosts[0]"
                  min="0"
                  class="cost-input"
                />
              </div>
              <div class="cost-input-group">
                <label>Down:</label>
                <input
                  type="number"
                  [(ngModel)]="editingCellCosts[1]"
                  min="0"
                  class="cost-input"
                />
              </div>
              <div class="cost-input-group">
                <label>Left:</label>
                <input
                  type="number"
                  [(ngModel)]="editingCellCosts[2]"
                  min="0"
                  class="cost-input"
                />
              </div>
              <div class="cost-input-group">
                <label>Right:</label>
                <input
                  type="number"
                  [(ngModel)]="editingCellCosts[3]"
                  min="0"
                  class="cost-input"
                />
              </div>
            </div>

            <div class="cost-inputs" *ngIf="isEditingEdgeCost">
              <div class="cost-input-group">
                <label>{{ editingEdgeDirection | titlecase }} Cost:</label>
                <input
                  type="number"
                  [(ngModel)]="editingEdgeCost"
                  min="1"
                  max="4"
                  class="cost-input"
                />
              </div>
            </div>

            <div class="cost-editor-actions">
              <button
                class="save-btn"
                (click)="isEditingCellCost ? saveCellCost() : saveEdgeCost()"
              >
                <i class="tool-icon">‚úì</i> Save
              </button>
              <button
                class="cancel-btn"
                (click)="
                  isEditingCellCost
                    ? cancelCellCostEdit()
                    : cancelEdgeCostEdit()
                "
              >
                <i class="tool-icon">‚úï</i> Cancel
              </button>
            </div>
          </div>
        </div>

        <button
          [class.active]="mode === 'generate-random'"
          (click)="generateRandomGrid()"
          title="Generate a random grid configuration"
        >
          <i class="tool-icon">üé≤</i> Generate Random
        </button>
        <button
          [class.active]="mode === 'delete'"
          (click)="setMode('delete')"
          title="Delete an item"
        >
          <i class="tool-icon">-</i> Delete
        </button>
      </div>

      <div class="tools-group">
        <h3>View Controls</h3>
        <button (click)="resetView()" title="Reset zoom and pan">
          <i class="tool-icon">‚ü≤</i> Reset View
        </button>
        <button (click)="resetGrid()" title="Clear the grid">
          <i class="tool-icon">üóë</i> Clear Grid
        </button>
      </div>

      <div class="tools-group">
        <h3>Strategy</h3>
        <select [(ngModel)]="selectedStrategy" class="strategy-select">
          <option *ngFor="let strategy of strategies" [value]="strategy">
            {{ strategy }}
          </option>
        </select>
      </div>

      <div class="tools-group">
        <h3>Export/Import</h3>
        <button
          (click)="exportGrid()"
          title="Export the grid configuration to JSON"
        >
          <i class="tool-icon">üì§</i> Export Grid
        </button>
        <div class="file-input-container">
          <label for="importGrid" class="file-input-label">
            <i class="tool-icon">üì•</i> Import Grid
          </label>
          <input
            type="file"
            id="importGrid"
            accept=".json"
            (change)="importGrid($event)"
            class="file-input"
          />
        </div>
      </div>

      <div class="tools-group">
        <h3>Plan Delivery</h3>
        <button
          class="solve-btn"
          (click)="planDelivery()"
          [disabled]="
            isLoading || stores.length === 0 || destinations.length === 0
          "
          title="Find optimal delivery routes"
        >
          Plan Routes
        </button>

        <div class="result" *ngIf="routes.length > 0" [@bounceAnimation]>
          <span>Found {{ routes.length }} route(s)</span>
          <div
            *ngFor="let route of routes; let i = index"
            class="route-info"
            [class.active-route]="currentAnimatingRoute === i && isAnimating"
            (click)="animateSpecificRoute(i)"
            title="Click to animate this route"
          >
            <small>Route {{ i + 1 }}: Cost {{ route.cost }}</small>
          </div>
        </div>
      </div>

      <div class="tools-group" *ngIf="routes.length > 0">
        <h3>Animation Controls</h3>
        <button
          (click)="stopRouteAnimation()"
          [disabled]="!isAnimating"
          title="Stop the route animation"
        >
          <i class="tool-icon">‚èπ</i> Stop Animation
        </button>
        <button
          (click)="startRouteAnimation()"
          [disabled]="isAnimating"
          title="Replay the route animation"
        >
          <i class="tool-icon">‚ñ∂</i> Replay
        </button>
        <div class="animation-speed-control">
          <label for="animationSpeed">Speed:</label>
          <input
            type="range"
            id="animationSpeed"
            [(ngModel)]="animationSpeed"
            min="50"
            max="1000"
            step="50"
            title="Animation speed in milliseconds"
          />
          <span>{{ animationSpeed }}ms</span>
        </div>
      </div>

      <div class="loading-container" *ngIf="isLoading" [@fadeAnimation]>
        <div class="spinner"></div>
        <span>Planning routes...</span>
      </div>
    </div>

    <div class="canvas-container">
      <canvas #gridCanvas></canvas>
      <div class="instructions" *ngIf="!showGrid" [@fadeAnimation]>
        <p>Welcome to the AI Package Delivery Planner!</p>
        <p>
          Use the tools on the left to get started and build your delivery
          network.
        </p>
      </div>
      <div class="mode-indicator" *ngIf="showGrid" [@slideAnimation]>
        Mode: {{ mode | titlecase }}
        <span *ngIf="tunnelStart" class="connecting-indicator"
          >Select tunnel exit at ({{ tunnelStart.x }},
          {{ tunnelStart.y }})</span
        >
      </div>
    </div>
  </div>

  <div class="legend" [@slideAnimation]>
    <h3>Legend</h3>
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-symbol store-symbol">S</div>
        <span>Store (Pickup)</span>
      </div>
      <div class="legend-item">
        <div class="legend-symbol destination-symbol">D</div>
        <span>Destination (Delivery)</span>
      </div>
      <div class="legend-item">
        <div class="legend-symbol tunnel-symbol">‚îÅ‚îÅ</div>
        <span>Tunnel (Shortcut)</span>
      </div>
      <div class="legend-item">
        <div class="legend-symbol roadblock-symbol">‚úï</div>
        <span>Roadblock</span>
      </div>
      <div class="legend-item">
        <div class="legend-symbol path-symbol">‚îÅ</div>
        <span>Delivery Route</span>
      </div>
    </div>
  </div>

  <div class="tips-and-tricks">
    <h3>Tips & Features</h3>
    <ul>
      <li>Use mouse wheel to zoom in and out</li>
      <li>Drag the canvas to move around</li>
      <li>Add stores (lavender circles with 'S') as pickup locations</li>
      <li>Add destinations (red squares with 'D') as delivery points</li>
      <li>Tunnels provide shortcuts between distant cells</li>
      <li>Choose different search strategies: BFS, DFS, UCS, A*, or Greedy</li>
      <li>Export your grid to save it, and import it later to continue</li>
      <li>
        <strong>How it works:</strong> The AI finds the optimal path from each
        store to each destination using the selected search algorithm,
        considering traffic costs and obstacles.
      </li>
    </ul>
  </div>
</div>
